---
interface Props {
  chart: string;
}

const { chart } = Astro.props;
---

<div class="mermaid-wrapper">
  <pre class="mermaid">{chart}</pre>
</div>

<script is:inline>
  (function() {
    if (typeof window === 'undefined') return;
    
    function getThemeColors() {
      const html = document.documentElement;
      const theme = html.getAttribute('data-theme') || 'auto';
      const isDark = theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
      
      if (isDark) {
        return {
          primaryColor: '#3b82f6',
          primaryTextColor: '#e5e5e5',
          primaryBorderColor: '#3b82f6',
          lineColor: '#a3a3a3',
          secondaryColor: '#262626',
          tertiaryColor: '#1a1a1a'
        };
      } else {
        return {
          primaryColor: '#2563eb',
          primaryTextColor: '#1a1a1a',
          primaryBorderColor: '#2563eb',
          lineColor: '#4a4a4a',
          secondaryColor: '#f5f5f5',
          tertiaryColor: '#fdfcfb'
        };
      }
    }
    
    function initializeMermaid() {
      const colors = getThemeColors();
      const script = document.createElement('script');
      script.type = 'module';
      script.textContent = `
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
          startOnLoad: true,
          theme: 'neutral',
          themeVariables: ${JSON.stringify(colors)}
        });
        mermaid.run();
        window.mermaidLoaded = true;
      `;
      document.head.appendChild(script);
    }
    
    if (!window.mermaidLoaded) {
      initializeMermaid();
    } else {
      setTimeout(function() {
        var mermaid = window.mermaid;
        if (mermaid && typeof mermaid.run === 'function') {
          mermaid.run();
        }
      }, 100);
    }
    
    // Reinitialize on theme change
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    mediaQuery.addEventListener('change', () => {
      const html = document.documentElement;
      const theme = html.getAttribute('data-theme');
      if (theme === 'auto' && window.mermaidLoaded) {
        // Reload page to reinitialize mermaid with new theme
        // This is a simple approach; could be improved with dynamic re-rendering
        const mermaidElements = document.querySelectorAll('.mermaid');
        if (mermaidElements.length > 0) {
          location.reload();
        }
      }
    });
  })();
</script>

<style>
  .mermaid-wrapper {
    margin: var(--space-lg) 0;
    padding: var(--space-md);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    overflow-x: auto;
  }
  
  .mermaid {
    display: flex;
    justify-content: center;
    background: transparent;
    padding: 0;
    margin: 0;
  }
</style>
