---
import BaseLayout from './BaseLayout.astro';
import ShareLinks from '../components/ShareLinks.astro';
import TagBadge from '../components/TagBadge.astro';
import ScrollButtons from '../components/ScrollButtons.astro';
import Comments from '../components/Comments.astro';
import AskAIChatbot from '../components/AskAIChatbot.astro';
import { formatDate } from '../utils/helpers';
import { generateArticleSchema, generateBreadcrumbSchema } from '../utils/seo';
import type { CollectionEntry } from 'astro:content';

interface Props {
  title: string;
  description: string;
  date: Date;
  tags: string[];
  image?: string;
  readingTime: string;
  series?: string;
  seriesPart?: number;
  seriesPosts?: Array<{ title: string; slug: string; part: number }>;
  post?: CollectionEntry<'blog'>;
}

const { title, description, date, tags, image, readingTime, series, seriesPart, seriesPosts, post } = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site).toString();

// Generate structured data
let articleSchema = null;
let breadcrumbSchema = null;

if (post) {
  articleSchema = generateArticleSchema(post, canonicalURL);
  
  // Generate breadcrumbs
  const breadcrumbItems = [
    { name: 'Home', url: '/' },
    { name: 'Blog', url: '/blog' },
    { name: title, url: Astro.url.pathname },
  ];
  breadcrumbSchema = generateBreadcrumbSchema(breadcrumbItems);
}

// Generate keywords from tags
const keywords = tags && tags.length > 0 ? tags.join(', ') : undefined;
---

<BaseLayout 
  title={title}
  description={description}
  image={image}
  article={true}
  publishedTime={date.toISOString()}
  modifiedTime={date.toISOString()}
  keywords={keywords}
>
  {articleSchema && <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />}
  {breadcrumbSchema && <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />}
  <article class="post-article">
    <div class="container">
      <div class="content-wrapper post-content-wrapper">
        <nav class="post-nav">
          <a href="/blog" class="nav-link">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Back to Blog</span>
          </a>
          <a href="/" class="nav-link">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3.33333 10L2.08333 11.25L2.08333 16.6667C2.08333 17.5871 2.82955 18.3333 3.75 18.3333H7.08333V12.5H12.9167V18.3333H16.25C17.1705 18.3333 17.9167 17.5871 17.9167 16.6667V11.25L16.6667 10M3.33333 10L10 3.33333L16.6667 10M3.33333 10H7.08333V8.33333C7.08333 7.41286 7.82955 6.66667 8.75 6.66667H11.25C12.1705 6.66667 12.9167 7.41286 12.9167 8.33333V10H16.6667" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Home</span>
          </a>
        </nav>
        
        <header class="post-header">
          {series && (
            <div class="series-badge">
              <span class="series-label">Series:</span>
              <span class="series-name">{series}</span>
              {seriesPart && (
                <span class="series-part">Part {seriesPart}</span>
              )}
            </div>
          )}
          
          <div class="post-meta">
            <time datetime={date.toISOString()}>{formatDate(date)}</time>
            <span class="separator">Â·</span>
            <span class="reading-time">{readingTime}</span>
          </div>
          
          <h1 class="post-title">{title}</h1>
          
          <p class="post-description">{description}</p>
          
          {tags && tags.length > 0 && (
            <div class="post-tags">
              {tags.map(tag => <TagBadge tag={tag} />)}
            </div>
          )}
        </header>
        
        <div class="post-content prose">
          <slot />
        </div>
        
        {series && seriesPosts && seriesPosts.length > 1 && (
          <div class="series-navigation">
            <h3 class="series-nav-title">More from {series}</h3>
            <div class="series-posts-list">
              {seriesPosts.map((post) => (
                <a 
                  href={`/blog/${post.slug}`}
                  class={`series-post-link ${post.part === seriesPart ? 'active' : ''}`}
                >
                  <span class="series-post-number">Part {post.part}</span>
                  <span class="series-post-title">{post.title}</span>
                </a>
              ))}
            </div>
          </div>
        )}
        
        <ShareLinks title={title} url={canonicalURL} />
        
        <Comments title={title} identifier={Astro.url.pathname} />
        
        <div class="subscribe-cta">
          <h3>Want more insights like this?</h3>
          <p>Get notified when I publish new articles on AI, architecture, and building intelligent systems.</p>
          <a href="/contact" class="cta-button">Get in Touch</a>
        </div>
      </div>
    </div>
  </article>
  <ScrollButtons />
  <AskAIChatbot currentUrl={Astro.url.pathname} postTitle={title} />
</BaseLayout>

<script is:inline>
  // External links enhancement - automatically processes all external links in blog posts
  function enhanceExternalLinks() {
    const currentHost = window.location.hostname;
    const postContent = document.querySelector('.post-content');
    
    if (!postContent) return;
    
    const links = postContent.querySelectorAll('a[href]:not(.external-link)');
    
    links.forEach(link => {
      // Skip if already processed
      if (link.classList.contains('external-link')) return;
      
      const href = link.getAttribute('href');
      if (!href) return;
      
      // Skip anchor links and mailto/tel links
      if (href.startsWith('#') || href.startsWith('mailto:') || href.startsWith('tel:')) return;
      
      // Check if it's an external link
      try {
        let url;
        // Handle absolute URLs
        if (href.startsWith('http://') || href.startsWith('https://')) {
          url = new URL(href);
        } else if (href.startsWith('//')) {
          url = new URL(window.location.protocol + href);
        } else {
          // Relative URL - not external
          return;
        }
        
        const isExternal = url.hostname !== currentHost && 
                         url.hostname !== '' &&
                         !url.hostname.startsWith('localhost') && 
                         !url.hostname.startsWith('127.0.0.1') &&
                         url.hostname !== window.location.hostname.replace('www.', '') &&
                         currentHost.replace('www.', '') !== url.hostname.replace('www.', '');
        
        if (isExternal) {
          // Add external link attributes
          link.setAttribute('target', '_blank');
          link.setAttribute('rel', 'noopener noreferrer');
          const linkText = link.textContent.trim() || href;
          link.setAttribute('aria-label', `${linkText} (opens in new tab: ${url.hostname})`);
          link.classList.add('external-link');
          
          // Add external link icon if not already present
          if (!link.querySelector('.external-link-icon')) {
            const icon = document.createElement('span');
            icon.className = 'external-link-icon';
            icon.setAttribute('aria-hidden', 'true');
            icon.innerHTML = `
              <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10.5 1.5L1.5 10.5M10.5 1.5H6M10.5 1.5V6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            `;
            link.appendChild(icon);
          }
          
          // Add tooltip on hover
          link.addEventListener('mouseenter', function() {
            if (!this.querySelector('.external-link-tooltip')) {
              const tooltip = document.createElement('span');
              tooltip.className = 'external-link-tooltip';
              tooltip.textContent = url.hostname;
              this.appendChild(tooltip);
            }
          });
        }
      } catch (e) {
        // Invalid URL, skip
        console.debug('Skipping invalid URL:', href);
      }
    });
  }

  // Run on DOMContentLoaded or immediately if already loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', enhanceExternalLinks);
  } else {
    // DOM already loaded, run immediately
    enhanceExternalLinks();
  }

  // Table scroll indicator management
  document.addEventListener('DOMContentLoaded', () => {
    const tableWrappers = document.querySelectorAll('.table-wrapper');
    
    tableWrappers.forEach(wrapper => {
      const table = wrapper.querySelector('table');
      if (!table) return;
      
      function checkScroll() {
        const isScrollable = wrapper.scrollWidth > wrapper.clientWidth;
        const isAtEnd = wrapper.scrollLeft + wrapper.clientWidth >= wrapper.scrollWidth - 5; // 5px tolerance
        
        if (isAtEnd) {
          wrapper.classList.add('scrolled-end');
        } else {
          wrapper.classList.remove('scrolled-end');
        }
        
        // Only show indicator if table is actually scrollable
        const htmlWrapper = wrapper;
        if (!isScrollable) {
          htmlWrapper.style.setProperty('--show-indicator', 'none');
        } else {
          htmlWrapper.style.setProperty('--show-indicator', 'block');
        }
      }
      
      // Check on load
      checkScroll();
      
      // Check on scroll
      wrapper.addEventListener('scroll', checkScroll);
      
      // Check on resize
      window.addEventListener('resize', checkScroll);
      
      // Initial check after a short delay to ensure table is rendered
      setTimeout(checkScroll, 100);
    });

    // Helper function to copy permalink
    function copyPermalink(id, anchor) {
      const url = new URL(window.location.href);
      url.hash = `#${id}`;
      const permalink = url.toString();
      
      // Copy to clipboard
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(permalink).then(() => {
          // Show feedback
          const feedback = document.createElement('span');
          feedback.className = 'anchor-feedback';
          feedback.textContent = 'Copied!';
          anchor.appendChild(feedback);
          setTimeout(() => {
            feedback.remove();
          }, 2000);
        }).catch(() => {
          // Fallback: select the URL
          const textarea = document.createElement('textarea');
          textarea.value = permalink;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          try {
            document.execCommand('copy');
            const feedback = document.createElement('span');
            feedback.className = 'anchor-feedback';
            feedback.textContent = 'Copied!';
            anchor.appendChild(feedback);
            setTimeout(() => {
              feedback.remove();
            }, 2000);
          } catch (err) {
            console.error('Failed to copy:', err);
          }
          document.body.removeChild(textarea);
        });
      }
      
      // Update URL without scrolling
      window.history.pushState(null, '', `#${id}`);
    }

    // Heading anchor links functionality
    const headings = document.querySelectorAll('.post-content h2[id], .post-content h3[id]');
    
    headings.forEach(heading => {
      const id = heading.getAttribute('id');
      if (!id) return;
      
      // Create anchor link element
      const anchor = document.createElement('a');
      anchor.href = `#${id}`;
      anchor.className = 'heading-anchor';
      anchor.setAttribute('aria-label', 'Copy link to this section');
      anchor.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M10 13C10.4295 13.5741 10.9774 14.0491 11.6066 14.3929C12.2357 14.7367 12.9315 14.9411 13.6467 14.9923C14.3618 15.0435 15.0796 14.9403 15.7513 14.6897C16.4231 14.4392 17.0331 14.047 17.54 13.54L20.54 10.54C21.4508 9.59695 21.9548 8.33394 21.9434 7.02296C21.932 5.71198 21.4061 4.45791 20.4791 3.53087C19.5521 2.60383 18.298 2.07801 16.987 2.06659C15.676 2.05517 14.413 2.55918 13.47 3.46997L11.75 5.17997" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M14 11C13.5705 10.4259 13.0226 9.9508 12.3934 9.60704C11.7643 9.26328 11.0685 9.05886 10.3533 9.00766C9.63816 8.95645 8.92037 9.05972 8.24865 9.31026C7.57693 9.5608 6.96688 9.95301 6.45997 10.46L3.45997 13.46C2.54918 14.403 2.04517 15.666 2.05659 16.977C2.06801 18.288 2.59383 19.5421 3.52087 20.4691C4.44791 21.3961 5.70198 21.922 7.01296 21.9334C8.32394 21.9448 9.58695 21.4408 10.53 20.53L12.24 18.82" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      `;
      
      // Handle click to copy permalink
      anchor.addEventListener('click', (e) => {
        e.preventDefault();
        copyPermalink(id, anchor);
      });
      
      // Insert anchor link into heading
      heading.appendChild(anchor);
    });

  });
</script>

<style>
  .post-article {
    padding: var(--space-lg) 0;
  }
  
  .post-nav {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--color-border);
  }
  
  .nav-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all var(--transition-fast);
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
  }
  
  .nav-link:hover {
    color: var(--color-accent);
    background: var(--color-code-bg);
  }
  
  .nav-link svg {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
  }
  
  .post-header {
    margin-bottom: var(--space-xl);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }
  
  .series-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--color-code-bg);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    font-size: 0.875rem;
    margin-bottom: var(--space-md);
  }
  
  .series-label {
    color: var(--color-text-secondary);
    font-weight: 500;
  }
  
  .series-name {
    color: var(--color-accent);
    font-weight: 600;
  }
  
  .series-part {
    color: var(--color-text-tertiary);
    font-weight: 500;
  }
  
  .post-meta {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: 0.875rem;
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-sm);
  }
  
  .separator {
    opacity: 0.5;
  }
  
  .post-title {
    font-size: 2.5rem;
    line-height: 1.2;
    margin-bottom: var(--space-sm);
    animation: fadeIn 0.6s ease-out;
  }
  
  .post-description {
    font-size: 1.25rem;
    line-height: 1.6;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-sm);
  }
  
  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
  }
  
  .post-content-wrapper {
    max-width: 900px;
  }
  
  .post-content {
    font-size: var(--text-lg);
    line-height: var(--leading-relaxed);
    font-family: var(--font-serif);
  }

  /* Heading anchor links */
  .post-content h2,
  .post-content h3 {
    position: relative;
    scroll-margin-top: 2rem;
  }

  .post-content h2 .heading-anchor,
  .post-content h3 .heading-anchor {
    position: absolute;
    left: -1.5rem;
    top: 50%;
    transform: translateY(-50%);
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none;
    transition: opacity var(--transition-fast);
    color: var(--color-text-secondary);
    text-decoration: none;
    display: flex;
    align-items: center;
    padding: 0.25rem;
    border-radius: 4px;
  }

  .post-content h2:hover .heading-anchor,
  .post-content h3:hover .heading-anchor {
    opacity: 1 !important;
    visibility: visible !important;
    pointer-events: auto;
  }

  .post-content h2 .heading-anchor:focus,
  .post-content h3 .heading-anchor:focus {
    opacity: 1 !important;
    visibility: visible !important;
    pointer-events: auto;
  }

  .post-content h2 .heading-anchor:hover,
  .post-content h3 .heading-anchor:hover {
    color: var(--color-accent);
    background: var(--color-code-bg);
  }

  .post-content h2 .heading-anchor svg,
  .post-content h3 .heading-anchor svg {
    width: 16px;
    height: 16px;
    display: block;
  }

  .anchor-feedback {
    position: absolute;
    left: 100%;
    margin-left: 0.5rem;
    font-size: 0.75rem;
    color: var(--color-accent);
    white-space: nowrap;
    animation: fadeInOut 2s ease-in-out;
  }

  @keyframes fadeInOut {
    0%, 100% { opacity: 0; transform: translateX(-5px); }
    10%, 90% { opacity: 1; transform: translateX(0); }
  }

  @media (max-width: 768px) {
    .post-content h2 .heading-anchor,
    .post-content h3 .heading-anchor {
      left: -1.25rem;
    }
  }
  
  .subscribe-cta {
    margin-top: var(--space-xl);
    padding: var(--space-lg);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    text-align: center;
  }
  
  .subscribe-cta h3 {
    margin-bottom: var(--space-sm);
    color: var(--color-text);
  }
  
  .subscribe-cta p {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-md);
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
  }
  
  .cta-button {
    display: inline-block;
    padding: 0.75rem 2rem;
    background: var(--color-accent);
    color: white;
    font-weight: 600;
    border-radius: 6px;
    text-decoration: none;
    transition: all var(--transition-base);
  }
  
  .cta-button:hover {
    background: var(--color-accent-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
  }
  
  .series-navigation {
    margin-top: var(--space-xl);
    margin-bottom: var(--space-lg);
    padding: var(--space-lg);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 8px;
  }
  
  .series-nav-title {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: var(--space-md);
    color: var(--color-text);
  }
  
  .series-posts-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }
  
  .series-post-link {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-sm) var(--space-md);
    border-radius: 6px;
    text-decoration: none;
    color: var(--color-text);
    transition: all var(--transition-fast);
    border: 1px solid transparent;
  }
  
  .series-post-link:hover {
    background: var(--color-code-bg);
    border-color: var(--color-border);
  }
  
  .series-post-link.active {
    background: var(--color-code-bg);
    border-color: var(--color-accent);
  }
  
  .series-post-link.active .series-post-number {
    color: var(--color-accent);
    font-weight: 600;
  }
  
  .series-post-number {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    min-width: 60px;
  }
  
  .series-post-title {
    font-size: 0.9375rem;
    color: var(--color-text);
    flex: 1;
  }
  
  .series-post-link:hover .series-post-title {
    color: var(--color-accent);
  }
  
  /* External link styling */
  .post-content .external-link {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .external-link-icon {
    display: inline-flex;
    align-items: center;
    opacity: 0.6;
    transition: opacity var(--transition-fast);
    flex-shrink: 0;
    margin-left: 0.125rem;
  }

  .external-link:hover .external-link-icon {
    opacity: 1;
  }

  .external-link-icon svg {
    width: 12px;
    height: 12px;
    vertical-align: middle;
  }

  .external-link-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-0.5rem);
    background: var(--color-text);
    color: var(--color-background);
    padding: 0.375rem 0.75rem;
    border-radius: 4px;
    font-size: 0.75rem;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity var(--transition-fast), transform var(--transition-fast);
    z-index: 1000;
    margin-bottom: 0.25rem;
    font-family: var(--font-sans);
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .external-link-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 4px solid transparent;
    border-top-color: var(--color-text);
  }

  .external-link:hover .external-link-tooltip {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  [data-theme="dark"] .external-link-tooltip,
  [data-theme="auto"] .external-link-tooltip {
    background: var(--color-text);
    color: var(--color-background);
  }
  
  @media (max-width: 768px) {
    .post-title {
      font-size: 2rem;
    }
    
    .post-description {
      font-size: 1.1rem;
    }
    
    .post-content {
      font-size: 1rem;
    }

    .external-link-tooltip {
      font-size: 0.6875rem;
      padding: 0.25rem 0.5rem;
    }
  }
</style>
